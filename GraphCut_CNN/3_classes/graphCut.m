function [BW,maskedImage] = graphCut(RGB)
%segmentImage Segment image using auto-generated code from imageSegmenter app
%  [BW,MASKEDIMAGE] = segmentImage(RGB) segments image RGB using
%  auto-generated code from the imageSegmenter app. The final segmentation
%  is returned in BW, and a masked image is returned in MASKEDIMAGE.

% Images should be the same at network input size, 224x224x224 before
% performing graphCut.

% Convert RGB image into L*a*b* color space.
% RGB = imread(fullfile(cd,'GraphCut_CNN\output_images\0005C.jpg'));
X = rgb2lab(RGB);

% Graph cut
foregroundInd = [491 714 716 934 2863 3169 3307 3314 3539 3987 4435 4643 5330 5853 5980 6002 6674 6873 6896 6897 7117 7118 7119 7120 7766 8113 8307 8539 8660 9107 9434 10451 10775 10778 11450 11674 12665 12670 12671 13142 13345 13556 15163 15838 16290 16460 16515 16742 16970 17195 17196 17197 17420 17421 17647 17873 18098 18319 19211 19844 20103 20994 21826 21888 22111 22560 23234 23803 24806 25928 28168 28315 30632 31495 33897 33908 33992 35351 35575 35799 35921 36023 36143 36144 36232 36247 36471 36919 37143 37591 37799 37815 38039 38263 38487 38711 38935 39159 39366 39383 39606 39829 40277 40460 40499 40710 40722 41170 41392 41605 41616 41845 42064 42068 42069 42287 42292 42735 42740 42950 42963 43183 43187 43411 43622 43635 43825 43846 43856 43858 43859 44070 44291 44304 44502 44509 44976 45200 45648 46096 46543 46767 46991 47215 47440 47890 48115 48317 48340 48342 48541 48542 48568 48768 48794 48796 48996 48998 48999 49001 49004 49012 49019 49021 ];
backgroundInd = [436 1106 1774 2889 4227 4673 5342 5564 5786 6455 6678 6901 6902 6904 7358 7591 7597 7825 8056 8057 8058 8281 8282 9170 10055 10938 10939 10940 10942 10948 10951 10953 11177 11178 11627 12299 13643 15657 17689 17690 18120 18360 18584 19911 21490 21927 22611 23942 25289 25508 26403 26625 26626 26849 27072 27296 27299 27520 27521 28207 32013 33580 34036 34037 34251 34252 34257 35150 36485 37155 37156 37382 37610 37841 38069 38270 38494 38500 38724 38740 38942 38946 39390 39391 39613 39836 39838 39857 40059 40283 40285 40508 40730 40732 41180 41401 41624 41628 41848 41867 42072 42076 42299 42519 42523 42524 42537 42538 42541 42743 42748 42749 42771 42967 43191 43198 43199 43216 43639 43862 44310 44328 44534 44758 44982 45206 45219 45220 45447 45655 45675 46104 46126 46127 46352 46353 46554 46779 46803 47003 47004 47005 47027 47028 47253 47478 ];
L = superpixels(X,351,'IsInputLab',true);

% Convert L*a*b* range to [0 1]
scaledX = prepLab(X);
BW = lazysnapping(scaledX,L,foregroundInd,backgroundInd);

% Create masked image.
maskedImage = RGB;
maskedImage(repmat(~BW,[1 1 3])) = 0;
end

function out = prepLab(in)

% Convert L*a*b* image to range [0,1]
out = in;
out(:,:,1)   = in(:,:,1) / 100;  % L range is [0 100].
out(:,:,2:3) = (in(:,:,2:3) + 100) / 200;  % a* and b* range is [-100,100].

end
